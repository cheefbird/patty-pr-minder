name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual workflow runs

jobs:
  test:
    name: Code Quality & Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x
    
    - name: Setup Biome
      uses: biomejs/setup-biome@v2
      with:
        version: latest
    
    - name: Run Biome
      run: biome ci .

    - name: Run linter
      run: deno lint

    - name: Type check manifest
      run: deno check manifest.ts

    - name: Type check project files
      run: |
        # Check all TypeScript files for type errors
        find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.git/*" | xargs -r deno check

    - name: Run tests
      env:
        TEST_GH_API: 0
      run: |
        if deno test --allow-env; then
          echo "âœ… Tests passed"
        elif [ $? -eq 1 ] && [[ $(deno test 2>&1) == *"No test modules found"* ]]; then
          echo "â„¹ï¸  No tests found - this is expected during early development"
          exit 0
        else
          echo "âŒ Tests failed"
          exit 1
        fi

    - name: Verify Slack manifest compiles
      run: |
        # Additional verification that manifest is valid
        deno eval "
        import manifest from './manifest.ts';
        console.log('âœ… Manifest loaded successfully - type:', typeof manifest);
        console.log('ğŸ“‹ Manifest structure keys:', Object.keys(manifest).length, 'properties');
        if (manifest.outgoing_domains) {
          console.log('ğŸŒ Outgoing domains configured:', manifest.outgoing_domains.length);
        }
        if (manifest.datastores) {
          console.log('ğŸ’¾ Datastores configured:', manifest.datastores.length);
        }
        console.log('ğŸ”§ Successfully verified manifest compilation');
        "